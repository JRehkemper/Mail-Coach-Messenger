<!DOCTYPE html>
<html>
    <head>
        <title>Chatroom</title>
        <meta charset="utf-8">
        <meta name="Realtime Chatroom Application" content="Realtime Chatroom Application">
        <meta name="Bigosigos.de & JRehkemper.de" content="SitePoint">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="text/css" rel="stylesheet" href="/css/style.css">
        <link rel="shortcut icon" type="image/x-icon" href="/img/chat.svg">

        <!-- Bootstrap css-->
        <link type="text/css" rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">      
    </head>
    
    <body>
        <script>
            var username = "";
            while(username == "")
            {
                username = prompt('Enter a Username:', '');
            }
            var loading = true;
        </script>
        <div class="container-fluid" id="MainWrapper">
            <div class="row" style="margin-top: 10vh;">
                <div class="col-2 d-none d-sm-none d-md-none">
                    
                </div>
                <div class="col-lg-8 col-xl-8 mx-auto HeaderDiv p-3" style="box-shadow: 0px 0px 2em 5px #111;">
                    <div class="Header pt-3 pb-1">
                        <h1 class="text-center HeaderM">Realtime Chatroom</h1>
                        <p class="text-center HeaderM">A bad, unreliable und unsafe way of communication</p>
                        <hr>
                        <p class="text-center HeaderM">Just enter a message and start chatting</p>
                        <p class="text-center HeaderM" style="font-size: 0.7em;">By using this Chatroom you agree to our <a href="javascript:alert('This is a public Chatroom. Please be aware that everybody can read this.\nThe Messages might be logged on the Server to enhance the User experience. We will not pass this data to others or use it for commercial purposes.')">Terms of use</a>.</p>
                        
                    </div>
                    <div class="Channel pt-1 mt-1 sticky-top">
                        <h5 class="text-center p-1 ChannelM">Main Channel - Everybody can read and write</h5>
                        <p class="text-center p-1 ChannelM" id="usercountId">Users</p>
                    </div>
                    <div class="Chatarea">
                        <div class="col-lg-10 col-xl-8 mx-auto pt-3 ChatMessages">
                            <ul id="messages" style="min-height: 45vh;">
                            </ul>
                        </div>
                        <!-- Chatinput -->
                        <div class="row ChatInput" >
                            <div class="col-12 col-lg-8 col-xl-8 mx-auto fixed-bottom formBackground">
                                <div class="col-12 col-lg-10 col-xl-8">
                                    <p id="typing"></p>
                                </div>
                                <div class="col-12 col-lg-10 col-xl-8 mx-auto ">
                                    <form id="form" action="">
                                        <input class="col-9 col-lg-9 col-xl-10" id="input" autocomplete="off" autofocus/><button class="col-3 col-lg-3 col-xl-2 text-center">Send</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-2 d-none d-sm-none d-md-none">

                </div>
            </div>
        </div>
        
        <!-- Bootstrap scripts -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.6.0/umd/popper.min.js" integrity="sha512-BmM0/BQlqh02wuK5Gz9yrbe7VyIVwOzD1o40yi1IsTjriX/NGF37NyXHfmFzIlMmoSIBXgqDiG1VNU6kB5dBbA==" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha512-z4OUqw38qNLpn1libAN9BsoDx6nbNFio5lA6CuTp9NlK83b89hgyCVq+N5FdBJptINztxn1Z3SaKSKUS5UP60Q==" crossorigin="anonymous"></script>
        <script>
            var audio = new Audio('sound/messageSound.mp3');
            audio.volume = 0.2;
            var socket = io();
            var messages = document.getElementById('messages');
            var form = document.getElementById('form');
            var input = document.getElementById('input');
            var usercountId = document.getElementById('usercountID');
            

            anime({
                targets: '#MainWrapper',
                opacity: [0, 1],
                duration: 2000,
            });
            anime({
                targets: '.Header',
                opacity: [0, 1],
                duration: 2000,
                delay: 300,
            });
            anime({
                targets: '.HeaderM',
                opacity: [0, 1],
                duration: 2000,
                delay: function(HeaderM, i=100, l) {
                    return 300 + i * 200;
                },
            });
            anime({
                targets: '.Channel',
                opacity: [0, 1],
                duration: 2000,
                delay: 600,
            });
            anime({
                targets: '.ChannelM',
                opacity: [0, 1],
                duration: 2000,
                delay: function(ChannelM, i=100, l) {
                    return 1000 + i * 200;
                },
            });
            anime({
                targets: 'li',
                opacity: [0, 1],
                duration: 2000,
                delay: function(li, i=100, l) {
                    return 1300 + i * 200;
                },
            });
            anime({
                targets: '.ChatInput',
                opacity: [0, 1],
                duration: 2000,
                delay: 900,
            });

            loading = false;

            if (performance.navigation.type == performance.navigation.TYPE_RELOAD) {
                console.info( "This page is reloaded" );
                socket.emit('refresh');
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (input.value) {
                    socket.emit('chat message', input.value, username);
                    input.value = '';
                }
            });

            /*document.getElementById('input').addEventListener('input', function(evt) {
              
                socket.emit('typing', username);
                console.log("typing");
                
            });*/

            socket.on('connection', function(pusername) {
                var item = document.createElement('li');
                item.textContent = "User joined the Chat";
                messages.appendChild(item);
                anime({
                    targets: document.getElementById('messages').lastElementChild,
                    translateY: [50, 0],
                    opacity: [0, 1],
                });
                window.scrollTo(0, document.body.scrollHeight);
                audio.play();
            });

            socket.on('disconnected', function(pusername) {
                var item = document.createElement('li');
                item.textContent = "User left the Chat";
                messages.appendChild(item);
                anime({
                    targets: document.getElementById('messages').lastElementChild,
                    translateY: [50, 0],
                    opacity: [0, 1],
                });
                window.scrollTo(0, document.body.scrollHeight);
                audio.play();
            });

            socket.on('chat message', function(msg, pusername) {
                var item = document.createElement('li');
                item.textContent = pusername+": "+msg;
                if (pusername == username) {
                    item.className = "text-left ownMessage";
                }
                else {
                    item.className = "text-left otherMessage";
                }
                messages.appendChild(item);
                /*anime({
                    targets: document.getElementById('messages').lastElementChild,
                    translateY: [50, 0],
                    opacity: [0, 1],
                });*/
                anime({
                    targets: document.querySelectorAll(".ownMessage:last-child"),
                    translateX: [50, 0],
                    translateY: [0, 0],
                    opacity: [0, 1],
                });
                anime({
                    targets: document.querySelectorAll(".otherMessage:last-child"),
                    translateX: [-50, 0],
                    translateY: [0, 0],
                    opacity: [0, 1],
                });

                //if(loading != true) {
                    $('html,body').animate({scrollTop: document.body.scrollHeight},"slow");
                //};
                if(username != pusername)
                {
                audio.play();
                }
            });

            /*socket.on('typing', function(pusername) {
                console.log(pusername + "is typing");
                document.getElementById('typing').innerHTML = "is typing a message";
            });*/

            socket.on('usercount', function(usercount) {
                document.getElementById('usercountId').innerHTML = "Connected Users: " + usercount;
            });
        </script>
    </body>
</html>